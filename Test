const btnAddOpen = document.getElementById("btnAddOpen");
const modalForm = document.getElementById("modalForm");
const saveWorker = document.getElementById("saveWorker");

const fullName = document.getElementById("fullName");
const email = document.getElementById("email");
const phone = document.getElementById("phone");
const photo = document.getElementById("photo");
const role = document.getElementById("role");

const expCompany = document.getElementById("expCompany");
const expRole = document.getElementById("expRole");
const expStart = document.getElementById("expStart");
const expEnd = document.getElementById("expEnd");
const addExp = document.getElementById("addExp");
const experienceList = document.getElementById("experienceList");

const popupSelect = document.getElementById("popupSelect");
const popupList = document.getElementById("popupList");
const closePopup = document.getElementById("closePopup");

const profilePopup = document.getElementById("profilePopup");
const profileName = document.getElementById("profileName");
const profilePhoto = document.getElementById("profilePhoto");
const profileRole = document.getElementById("profileRole");
const profileEmail = document.getElementById("profileEmail");
const profilePhone = document.getElementById("profilePhone");
const profileExperiences = document.getElementById("profileExperiences");
const closeProfile = document.getElementById("closeProfile");

const unassignedList = document.getElementById("unassignedList");

const rooms = {
  roomOne: document.getElementById("roomOne"),
  roomTwo: document.getElementById("roomTwo"),
  roomTree: document.getElementById("roomTree"),
  roomFor: document.getElementById("roomFor"),
  roomFive: document.getElementById("roomFive"),
  roomsx: document.getElementById("roomsx")
};

let workers = JSON.parse(localStorage.getItem("workers")) || [];
let experiences = [];



btnAddOpen.addEventListener("click", function () {
  modalForm.classList.remove("hidden");
});


saveWorker.addEventListener("click", function () {

  if (fullName.value === "") {
    alert("Enter name!");
    return;
  }

  // حفظ التجارب (بدون spread)
  let copiedExp = [];
  for (let i = 0; i < experiences.length; i++) {
    copiedExp.push(experiences[i]);
  }

  let worker = {
    id: Date.now(),
    name: fullName.value,
    email: email.value,
    phone: phone.value,
    photo: photo.value,
    role: role.value,
    experiences: copiedExp,
    room: null
  };

  workers.push(worker);

  experiences = [];

  saveData();
  renderWorkers();
  clearForm();

  modalForm.classList.add("hidden");
});


// إضافة تجربة
addExp.addEventListener("click", function () {

  if (expCompany.value === "" || expRole.value === "") {
    alert("Complete experience!");
    return;
  }

  let exp = {
    company: expCompany.value,
    role: expRole.value,
    start: expStart.value,
    end: expEnd.value
  };

  experiences.push(exp);

  renderExperienceList();

  expCompany.value = "";
  expRole.value = "";
  expStart.value = "";
  expEnd.value = "";
});


// عرض اللائحة داخل الفورم
function renderExperienceList() {
  experienceList.innerHTML = "";

  for (let i = 0; i < experiences.length; i++) {
    let e = experiences[i];

    let div = document.createElement("div");
    div.textContent = e.role + " at " + e.company + " (" + e.start + " - " + e.end + ")";
    experienceList.appendChild(div);
  }
}


// حفظ البيانات
function saveData() {
  localStorage.setItem("workers", JSON.stringify(workers));
}


// عرض العمال غير المعينين
function renderWorkers() {

  unassignedList.innerHTML = "";

  for (let i = 0; i < workers.length; i++) {
    let worker = workers[i];

    if (worker.room === null) {

      let div = document.createElement("div");
      div.className = "flex items-center gap-2 bg-white p-2 rounded cursor-pointer hover:bg-blue-100";

      div.innerHTML =
        '<img src="' +
        worker.photo +
        '" class="w-10 h-10 rounded-full object-cover">' +
        '<span>' +
        worker.name +
        "</span>";

      div.addEventListener("click", function () {
        openProfile(worker.id);
      });

      unassignedList.appendChild(div);
    }
  }
}



function openProfile(id) {

  let worker = null;

  for (let i = 0; i < workers.length; i++) {
    if (workers[i].id === id) {
      worker = workers[i];
      break;
    }
  }

  if (!worker) return;

  profileName.textContent = worker.name;
  profilePhoto.src = worker.photo;
  profileRole.textContent = worker.role;
  profileEmail.textContent = worker.email;
  profilePhone.textContent = worker.phone;

  profileExperiences.innerHTML = "";
  for (let i = 0; i < worker.experiences.length; i++) {
    let e = worker.experiences[i];
    let p = document.createElement("p");
    p.textContent = e.role + " at " + e.company + " (" + e.start + " - " + e.end + ")";
    profileExperiences.appendChild(p);
  }

  profilePopup.classList.remove("hidden");
}



closeProfile.addEventListener("click", function () {
  profilePopup.classList.add("hidden");
});



function renderRooms() {

  let r = Object.values(rooms);
  for (let x = 0; x < r.length; x++) {
    let room = r[x];
    let cards = room.querySelectorAll(".workerCard");

    for (let c = 0; c < cards.length; c++) {
      cards[c].remove();
    }
  }


  for (let i = 0; i < workers.length; i++) {

    let worker = workers[i];

    if (worker.room !== null) {

      let roomDiv = rooms[worker.room];

      let div = document.createElement("div");
      div.className =
        "workerCard flex items-center gap-2 bg-green-200 p-1 rounded mt-1 cursor-pointer";

      div.innerHTML =
        '<img src="' +
        worker.photo +
        '" class="w-8 h-8 rounded-full object-cover">' +
        "<span>" +
        worker.name +
        "</span>" +
        '<button class="bg-red-500 text-white px-1 rounded">X</button>';

      div.querySelector("button").addEventListener("click", function () {
        worker.room = null;
        saveData();
        renderWorkers();
        renderRooms();
      });

      div.addEventListener("click", function () {
        openProfile(worker.id);
      });

      roomDiv.appendChild(div);
    }
  }


  let entries = Object.entries(rooms);

  for (let i = 0; i < entries.length; i++) {
    let key = entries[i][0];
    let room = entries[i][1];

    let count = 0;

    for (let j = 0; j < workers.length; j++) {
      if (workers[j].room === key) {
        count++;
      }
    }

    let empty = count === 0;

    if (empty && key !== "roomOne" && key !== "roomFive") {
      room.style.backgroundColor = "#ffcccc";
    } else {
      room.style.backgroundColor = "white";
    }
  }
}



let addBtns = document.querySelectorAll(".addBtn");

for (let i = 0; i < addBtns.length; i++) {
  addBtns[i].addEventListener("click", function (e) {

    let roomDiv = e.target.closest("div");
    let roomId = roomDiv.id;

    popupList.innerHTML = "";

    for (let j = 0; j < workers.length; j++) {

      let w = workers[j];

      if (w.room === null && checkRoleRoom(w.role, roomId)) {

        let p = document.createElement("p");
        p.className = "cursor-pointer hover:bg-gray-200 p-1";
        p.textContent = w.name;

        p.addEventListener("click", function () {
          w.room = roomId;
          saveData();
          renderWorkers();
          renderRooms();
          popupSelect.classList.add("hidden");
        });

        popupList.appendChild(p);
      }
    }

    popupSelect.classList.remove("hidden");
  });
}


closePopup.addEventListener("click", function () {
  popupSelect.classList.add("hidden");
});


function checkRoleRoom(role, roomId) {
  if (roomId === "roomTwo" && role !== "receptionist") return false;
  if (roomId === "roomsx" && role !== "IT") return false;
  if (roomId === "roomTree" && role !== "security") return false;
  if (role === "cleaning" && roomId === "roomFor") return false;
  return true;
}



function clearForm() {
  fullName.value = "";
  email.value = "";
  phone.value = "";
  photo.value = "";u
  role.value = "manager";

  experiences = [];
  renderExperienceList();
}


f
renderWorkers();
renderRooms();
