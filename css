// main.js

// --- Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ HTML Ø§Ù„Ø°ÙŠ Ø£Ø±Ø³Ù„ØªÙ‡ ---
const newTxBtn = document.getElementById('newTransaction'); // Ø²Ø± Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
const addSection = document.getElementById('add');         // Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
const dateInput = document.getElementById('date-T');       // ØªØ§Ø±ÙŠØ®
const textInputs = document.querySelectorAll('#text-T');    // Ù…Ù„Ø§Ø­Ø¸Ø©: HTML ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ id Ù…ÙƒØ±Ø± => Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨
// Ù†Ø¹ØªØ¨Ø± textInputs[0] = description, textInputs[1] = amount
const descInput = textInputs[0] || null;
const amountInput = textInputs[1] || null;
const addingBtn = document.getElementById('adding');      // Ø²Ø± Add Transaction Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬

// Ø²Ø±ÙŠÙ’ Ø§Ù„Ù†ÙˆØ¹ (Income / Expense) Ù…ÙˆØ¬ÙˆØ¯Ø§Ù† ÙƒØ£Ø²Ø±Ø§Ø± Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„Ù‚Ø³Ù…ØŒ Ù„ÙƒÙ† Ø¨Ù„Ø§ id.
// Ø³Ù†Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø³Ù… ÙˆÙ†Ø·Ø§Ø¨Ù‚ Ø§Ù„Ù†Øµ.
let incomeBtn = null;
let expenseBtn = null;
if (addSection) {
  const buttonsInAdd = addSection.querySelectorAll('button');
  buttonsInAdd.forEach(b => {
    const txt = (b.textContent || b.innerText || '').trim().toLowerCase();
    if (txt === 'income' || txt === 'income') incomeBtn = b;
    if (txt === 'expense' || txt === 'expense') expenseBtn = b;
  });
}

// Ø¥Ø°Ø§ Ù„Ù… Ù†Ø³ØªØ·Ø¹ Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø§Ù„Ù†ØµØŒ Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø²Ø±Ø§Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø³Ù… ÙˆÙØ±Ø²Ù‡Ø§
if (!incomeBtn || !expenseBtn) {
  const allBtns = addSection ? addSection.querySelectorAll('button') : [];
  if (allBtns.length >= 2) {
    incomeBtn = allBtns[0];
    expenseBtn = allBtns[1];
  }
}

// --- ØªØ­Ø¶ÙŠØ± Ù…ÙƒØ§Ù† Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ® (History) ---
// Ù†Ø­Ø§ÙˆÙ„ Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø§Ù„Ù†Øµ "History of Transactions" Ø«Ù… Ù†Ø¶ÙŠÙ Ø¨Ø¹Ø¯Ù‡ Ø­Ø§ÙˆÙŠØ© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©.
// Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯Ù‡ØŒ Ù†Ù„ØµÙ‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù€ body.
function findHistoryContainer() {
  const allElements = document.querySelectorAll('p, div, span, h1, h2, h3');
  for (const el of allElements) {
    if ((el.textContent || '').trim().toLowerCase().includes('history of transactions')) {
      return el;
    }
  }
  return null;
}

const historyAnchor = findHistoryContainer();
let listContainer = document.createElement('div');
listContainer.id = 'transactionsList';
listContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 w-full max-w-5xl mx-auto p-4';

// Ø¥Ø°Ø§ ÙˆØ¬Ø¯Ù†Ø§ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØŒ Ù†Ø¶ÙŠÙ Ø¨Ø¹Ø¯Ù‡ Ø§Ù„Ø­Ø§ÙˆÙŠØ©ØŒ ÙˆØ¥Ù„Ø§ Ù†Ù„ØµÙ‚Ù‡Ø§ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù€ main Ø£Ùˆ body
if (historyAnchor && historyAnchor.parentElement) {
  // Ø¶Ø¹ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ
  historyAnchor.parentElement.insertBefore(listContainer, historyAnchor.nextSibling);
} else {
  const main = document.querySelector('main') || document.body;
  main.appendChild(listContainer);
}

// --- Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬: Ù…Ø®ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© ---
if (addSection) addSection.style.display = 'none';

// --- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª ---
let transactions = JSON.parse(localStorage.getItem('transactions')) || [];

// Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø°ÙŠ ÙŠØ­Ù…Ù„ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (-1 ÙŠØ¹Ù†ÙŠ Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©)
let editingIndex = -1;
let selectedType = 'income'; // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©

// --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ---
function saveToLocal() {
  localStorage.setItem('transactions', JSON.stringify(transactions));
}

function formatCurrency(val) {
  // Ù†Ø­Ø§ÙˆÙ„ ØªØ­ÙˆÙŠÙ„ Ù‚ÙŠÙ…Ø© Ù†ØµÙŠØ© Ø¥Ù„Ù‰ Ø±Ù‚Ù… Ø«Ù… Ù†ÙØ¹ÙŠØ¯Ù‡Ø§ Ø¨ØµÙŠØºØ© Ø«Ø§Ø¨ØªØ© Ø¨Ù…Ø±ØªÙŠÙ† Ø¹Ø´Ø±ÙŠØªÙŠÙ†
  const num = parseFloat(String(val).replace(/[^0-9.-]/g, ''));
  if (Number.isNaN(num)) return val;
  // Ù„Ø§ Ù†Ø¶Ø¹ Ø±Ù…Ø² Ø§Ù„Ø¹Ù…Ù„Ø© Ù‡Ù†Ø§ Ù„Ø£Ù† HTML Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¶Ø¹ "$" ÙÙŠ placeholder
  return num.toFixed(2);
}

function clearForm() {
  if (descInput) descInput.value = '';
  if (amountInput) amountInput.value = '';
  if (dateInput) dateInput.value = '';
  selectedType = 'income';
  if (incomeBtn) incomeBtn.classList.remove('opacity-50');
  if (expenseBtn) expenseBtn.classList.add('opacity-50');
  editingIndex = -1;
  if (addingBtn) {
    addingBtn.textContent = 'Add Transaction';
  }
}

// --- Ø±Ù†Ø¯Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ---
function renderList() {
  listContainer.innerHTML = '';

  if (!transactions.length) {
    const empty = document.createElement('p');
    empty.className = 'text-gray-500 text-center col-span-full';
    empty.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¨Ø¹Ø¯ ğŸ•Šï¸';
    listContainer.appendChild(empty);
    return;
  }

  transactions.forEach((t, idx) => {
    const card = document.createElement('div');
    card.className = 'bg-white rounded-2xl shadow-md p-5 flex flex-col justify-between hover:shadow-xl transition';

    // Ø´ÙƒÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
    const inner = document.createElement('div');
    inner.innerHTML = `
      <div>
        <div class="flex justify-between items-center mb-2">
          <h3 class="font-bold text-xl ${t.type === 'income' ? 'text-green-600' : 'text-red-600'}">${t.type === 'income' ? 'Income' : 'Expense'}</h3>
          <span class="text-sm text-gray-500">${t.date || 'â€”'}</span>
        </div>
        <p class="text-gray-700 mb-1">ğŸ’° <span class="font-semibold">${t.amount}</span></p>
        <p class="text-gray-600 text-sm">${t.desc || 'â€” Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø±Ø­ â€”'}</p>
      </div>
    `;

    const actions = document.createElement('div');
    actions.className = 'flex justify-end mt-4 space-x-2 space-x-reverse';
    actions.innerHTML = `
      <button data-idx="${idx}" class="editBtn bg-yellow-400 hover:bg-yellow-500 text-white px-3 py-1 rounded-lg text-sm transition">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
      <button data-idx="${idx}" class="deleteBtn bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-sm transition">ğŸ—‘ï¸ Ø­Ø°Ù</button>
    `;

    card.appendChild(inner);
    card.appendChild(actions);
    listContainer.appendChild(card);

    // Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    const delBtn = card.querySelector('.deleteBtn');
    const editBtn = card.querySelector('.editBtn');
    delBtn.addEventListener('click', () => deleteTransaction(idx));
    editBtn.addEventListener('click', () => startEdit(idx));
  });
}

// --- Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù…Ù„Ø© ---
function addTransaction() {
  // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚ÙŠÙ…
  const desc = descInput ? descInput.value.trim() : '';
  const amountRaw = amountInput ? amountInput.value.trim() : '';
  const date = dateInput ? dateInput.value : '';

  if (!amountRaw || !date) {
    alert('Ø§Ù„Ù…Ø±Ø¬Ùˆ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…Ø¨Ù„Øº.');
    return;
  }

  const amount = formatCurrency(amountRaw);

  const tx = {
    type: selectedType, // 'income' Ø£Ùˆ 'expense'
    amount,
    date,
    desc,
  };

  transactions.push(tx);
  saveToLocal();
  renderList();
  clearForm();
  // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
  if (addSection) addSection.style.display = 'none';
}

// --- Ø­Ø°Ù ---
function deleteTransaction(index) {
  if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©ØŸ')) return;
  transactions.splice(index, 1);
  saveToLocal();
  renderList();
}

// --- Ø¨Ø¯Ø§ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ ---
function startEdit(index) {
  const t = transactions[index];
  if (!t) return;
  // Ù…Ù„Ø£ Ø§Ù„Ø­Ù‚ÙˆÙ„
  if (descInput) descInput.value = t.desc || '';
  if (amountInput) amountInput.value = t.amount || '';
  if (dateInput) dateInput.value = t.date || '';
  selectedType = t.type || 'income';
  // ØªÙ…ÙŠÙŠØ² Ø²Ø± Ø§Ù„Ù†ÙˆØ¹
  if (selectedType === 'income') {
    if (incomeBtn) incomeBtn.classList.remove('opacity-50');
    if (expenseBtn) expenseBtn.classList.add('opacity-50');
  } else {
    if (expenseBtn) expenseBtn.classList.remove('opacity-50');
    if (incomeBtn) incomeBtn.classList.add('opacity-50');
  }

  // Ø§Ø¶Ù‡Ø§Ø± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø®ÙÙŠØ§Ù‹
  if (addSection) addSection.style.display = 'block';

  // ØªØºÙŠÙŠØ± ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø²Ø± Ù„ÙŠØµØ¨Ø­ ØªØ­Ø¯ÙŠØ«Ù‹Ø§
  editingIndex = index;
  if (addingBtn) {
    addingBtn.textContent = 'Update Transaction';
    // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ event handler: Ø£ÙˆÙ„Ø§Ù‹ Ù†Ø²ÙŠÙ„ Ø£ÙŠ Ù…Ø³ØªÙ…Ø¹ Ø³Ø§Ø¨Ù‚ Ø«Ù… Ù†Ø¶ÙŠÙ ÙˆØ§Ø­Ø¯ Ø¬Ø¯ÙŠØ¯
    addingBtn.replaceWith(addingBtn.cloneNode(true));
    const newAddingBtn = document.getElementById('adding');
    newAddingBtn.addEventListener('click', () => updateTransaction(index));
  }
}

// --- Ø§Ù„ØªØ­Ø¯ÙŠØ« ---
function updateTransaction(index) {
  const desc = descInput ? descInput.value.trim() : '';
  const amountRaw = amountInput ? amountInput.value.trim() : '';
  const date = dateInput ? dateInput.value : '';

  if (!amountRaw || !date) {
    alert('Ø§Ù„Ù…Ø±Ø¬Ùˆ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…Ø¨Ù„Øº.');
    return;
  }

  const amount = formatCurrency(amountRaw);

  transactions[index] = {
    type: selectedType,
    amount,
    date,
    desc,
  };

  saveToLocal();
  renderList();
  clearForm();
  if (addSection) addSection.style.display = 'none';

  // Ø¥Ø¹Ø§Ø¯Ø© Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø­Ø§Ù„ØªÙ‡ Ø§Ù„Ø£ØµÙ„ÙŠØ©
  const newAddingBtn = document.getElementById('adding');
  if (newAddingBtn) {
    newAddingBtn.textContent = 'Add Transaction';
    newAddingBtn.replaceWith(newAddingBtn.cloneNode(true));
    document.getElementById('adding').addEventListener('click', addTransaction);
  }
}

// --- ØªØ¨Ø¯ÙŠÙ„ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± ---
if (incomeBtn) {
  incomeBtn.addEventListener('click', (e) => {
    selectedType = 'income';
    incomeBtn.classList.remove('opacity-50');
    if (expenseBtn) expenseBtn.classList.add('opacity-50');
  });
}
if (expenseBtn) {
  expenseBtn.addEventListener('click', (e) => {
    selectedType = 'expense';
    expenseBtn.classList.remove('opacity-50');
    if (incomeBtn) incomeBtn.classList.add('opacity-50');
  });
}

// --- Ø²Ø± Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¶Ø§ÙØ© ---
if (newTxBtn) {
  newTxBtn.addEventListener('click', () => {
    if (!addSection) return;
    if (addSection.style.display === 'none' || addSection.style.display === '') {
      addSection.style.display = 'block';
      // ØªØºÙŠÙŠØ± Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„ÙŠØ¶ÙŠÙ Ù…Ø¹Ø§Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
      const newAddingBtn = document.getElementById('adding');
      if (newAddingBtn) {
        newAddingBtn.textContent = 'Add Transaction';
        newAddingBtn.replaceWith(newAddingBtn.cloneNode(true));
        document.getElementById('adding').addEventListener('click', addTransaction);
      }
    } else {
      addSection.style.display = 'none';
    }
  });
}

// --- Ø¶Ø¨Ø· Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ---
const initAddBtn = document.getElementById('adding');
if (initAddBtn) {
  // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ ÙˆØ¸Ø§Ø¦Ù Ø³Ø§Ø¨Ù‚Ø© Ø«Ù… Ø¥Ø¶Ø§ÙØ© addTransaction
  initAddBtn.replaceWith(initAddBtn.cloneNode(true));
  document.getElementById('adding').addEventListener('click', addTransaction);
}

// --- ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
clearForm();
renderList();
